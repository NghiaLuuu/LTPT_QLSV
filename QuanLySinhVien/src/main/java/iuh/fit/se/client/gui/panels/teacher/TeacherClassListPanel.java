package iuh.fit.se.client.gui.panels.teacher;

import iuh.fit.se.client.gui.TeacherMainFrame;
import iuh.fit.se.client.net.NetworkClient;
import iuh.fit.se.common.dto.AuthResponseDTO;
import iuh.fit.se.common.dto.LopHocPhanDTO;
import iuh.fit.se.common.protocol.Command;
import iuh.fit.se.common.protocol.Request;
import iuh.fit.se.common.protocol.Response;
import iuh.fit.se.common.protocol.Status;

import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.util.List;

/**
 * Panel hi·ªÉn th·ªã danh s√°ch l·ªõp h·ªçc ph·∫ßn c·ªßa gi·∫£ng vi√™n
 */
public class TeacherClassListPanel extends JPanel implements TeacherMainFrame.RefreshablePanel {
    private NetworkClient networkClient;
    private AuthResponseDTO authResponse;
    private JTable table;
    private DefaultTableModel tableModel;
    private JLabel lblStatus;

    public TeacherClassListPanel(NetworkClient networkClient, AuthResponseDTO authResponse) {
        this.networkClient = networkClient;
        this.authResponse = authResponse;
        initComponents();
        setupLayout();
        loadData();
    }

    private void initComponents() {
        setLayout(new BorderLayout(10, 10));
        setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));

        String[] columnNames = {"M√£ LHP", "T√™n m√¥n h·ªçc", "H·ªçc k·ª≥", "NƒÉm h·ªçc", "Th·ª©", "Ti·∫øt", "Ph√≤ng", "Sƒ© s·ªë"};
        tableModel = new DefaultTableModel(columnNames, 0) {
            @Override
            public boolean isCellEditable(int row, int column) {
                return false;
            }
        };
        table = new JTable(tableModel);
        table.setRowHeight(30);
        table.setFont(new Font("Segoe UI", Font.PLAIN, 13));
        table.getTableHeader().setFont(new Font("Segoe UI", Font.BOLD, 13));
    }

    private void setupLayout() {
        // Title panel
        JPanel titlePanel = new JPanel(new BorderLayout());
        titlePanel.setBackground(new Color(41, 128, 185));
        titlePanel.setBorder(BorderFactory.createEmptyBorder(15, 20, 15, 20));

        JLabel lblTitle = new JLabel("üìö DANH S√ÅCH L·ªöP H·ªåC PH·∫¶N C·ª¶A T√îI");
        lblTitle.setFont(new Font("Segoe UI", Font.BOLD, 18));
        lblTitle.setForeground(Color.WHITE);
        titlePanel.add(lblTitle, BorderLayout.WEST);

        JButton btnRefresh = new JButton("üîÑ L√†m m·ªõi");
        btnRefresh.setFont(new Font("Segoe UI", Font.BOLD, 13));
        btnRefresh.setBackground(Color.WHITE);
        btnRefresh.setFocusPainted(false);
        btnRefresh.addActionListener(e -> loadData());
        titlePanel.add(btnRefresh, BorderLayout.EAST);

        add(titlePanel, BorderLayout.NORTH);

        // Table
        JScrollPane scrollPane = new JScrollPane(table);
        scrollPane.setBorder(BorderFactory.createTitledBorder("Danh s√°ch l·ªõp"));
        add(scrollPane, BorderLayout.CENTER);

        // Status bar
        JPanel statusPanel = new JPanel(new FlowLayout(FlowLayout.LEFT));
        lblStatus = new JLabel("S·∫µn s√†ng");
        lblStatus.setFont(new Font("Segoe UI", Font.PLAIN, 12));
        statusPanel.add(lblStatus);
        add(statusPanel, BorderLayout.SOUTH);
    }

    private void loadData() {
        lblStatus.setText("‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...");

        SwingWorker<Response, Void> worker = new SwingWorker<Response, Void>() {
            @Override
            protected Response doInBackground() throws Exception {
                Request request = new Request(Command.GV_GET_MY_CLASSES,
                    authResponse.getMaGV(),
                    authResponse.getAuthToken());
                return networkClient.sendRequest(request);
            }

            @Override
            protected void done() {
                try {
                    Response response = get();
                    if (response.getStatus() == Status.SUCCESS) {
                        @SuppressWarnings("unchecked")
                        List<LopHocPhanDTO> classes = (List<LopHocPhanDTO>) response.getData();
                        loadDataToTable(classes);
                        lblStatus.setText("‚úì ƒê√£ t·∫£i " + classes.size() + " l·ªõp h·ªçc ph·∫ßn");
                    } else {
                        lblStatus.setText("‚úó L·ªói: " + response.getMessage());
                        JOptionPane.showMessageDialog(TeacherClassListPanel.this,
                            response.getMessage(),
                            "L·ªói",
                            JOptionPane.ERROR_MESSAGE);
                    }
                } catch (Exception e) {
                    lblStatus.setText("‚úó L·ªói k·∫øt n·ªëi");
                    JOptionPane.showMessageDialog(TeacherClassListPanel.this,
                        "Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: " + e.getMessage(),
                        "L·ªói",
                        JOptionPane.ERROR_MESSAGE);
                }
            }
        };
        worker.execute();
    }

    private void loadDataToTable(List<LopHocPhanDTO> classes) {
        tableModel.setRowCount(0);
        for (LopHocPhanDTO lhp : classes) {
            Object[] row = {
                lhp.getMaLHP(),
                lhp.getTenMH(),
                lhp.getTenHocKy(),
                lhp.getNamHoc(),
                lhp.getThu(),
                lhp.getTiet(),
                lhp.getPhongHoc(),
                lhp.getSiSo()
            };
            tableModel.addRow(row);
        }
    }

    @Override
    public void refresh() {
        loadData();
    }
}

