package iuh.fit.se.client.gui;

import iuh.fit.se.common.dto.AuthResponseDTO;
import iuh.fit.se.common.model.UserRole;
import iuh.fit.se.common.protocol.Command;
import iuh.fit.se.common.protocol.Request;
import iuh.fit.se.common.protocol.Response;
import iuh.fit.se.client.net.NetworkClient;
import iuh.fit.se.client.gui.panels.*;

import javax.swing.*;
import java.awt.*;

/**
 * M√†n h√¨nh ch√≠nh cho Admin - Qu·∫£n l√Ω to√†n b·ªô h·ªá th·ªëng
 */
public class AdminMainFrame extends JFrame {
    private AuthResponseDTO authResponse;
    private NetworkClient networkClient;
    private JTabbedPane tabbedPane;

    // Panels
    private KhoaPanel khoaPanel;
    private LopHocPanel lopHocPanel;
    private GiangVienPanel giangVienPanel;
    private MonHocPanel monHocPanel;
    private HocKyPanel hocKyPanel;
    private SinhVienPanel sinhVienPanel;
    private LopHocPhanPanel lopHocPhanPanel;

    public AdminMainFrame(AuthResponseDTO authResponse, NetworkClient networkClient) {
        this.authResponse = authResponse;
        this.networkClient = networkClient;

        initComponents();
        setupLayout();
        setupMenuBar();
    }

    private void initComponents() {
        setTitle("H·ªá th·ªëng Qu·∫£n l√Ω ƒê√†o t·∫°o - " + authResponse.getUsername() +
                 " (" + getRoleDisplayName() + ")");
        setSize(1200, 700);
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setLocationRelativeTo(null);

        // Create tabbed pane
        tabbedPane = new JTabbedPane();
        tabbedPane.setFont(new Font("Arial", Font.PLAIN, 13));
    }

    private void setupLayout() {
        // Create panels based on role
        if (authResponse.getRole() == UserRole.ADMIN) {
            // Admin has access to all panels
            khoaPanel = new KhoaPanel(networkClient, authResponse.getAuthToken());
            lopHocPanel = new LopHocPanel(networkClient, authResponse.getAuthToken());
            giangVienPanel = new GiangVienPanel(networkClient, authResponse.getAuthToken());
            monHocPanel = new MonHocPanel(networkClient, authResponse.getAuthToken());
            hocKyPanel = new HocKyPanel(networkClient, authResponse.getAuthToken());
            sinhVienPanel = new SinhVienPanel(networkClient, authResponse.getAuthToken());
            lopHocPhanPanel = new LopHocPhanPanel(networkClient, authResponse.getAuthToken());

            tabbedPane.addTab("üìö Qu·∫£n l√Ω Khoa", khoaPanel);
            tabbedPane.addTab("üè´ Qu·∫£n l√Ω L·ªõp h·ªçc", lopHocPanel);
            tabbedPane.addTab("üë®‚Äçüè´ Qu·∫£n l√Ω Gi·∫£ng vi√™n", giangVienPanel);
            tabbedPane.addTab("üìñ Qu·∫£n l√Ω M√¥n h·ªçc", monHocPanel);
            tabbedPane.addTab("üìÖ Qu·∫£n l√Ω H·ªçc k·ª≥", hocKyPanel);
            tabbedPane.addTab("üë®‚Äçüéì Qu·∫£n l√Ω Sinh vi√™n", sinhVienPanel);
            tabbedPane.addTab("üéì Qu·∫£n l√Ω L·ªõp h·ªçc ph·∫ßn", lopHocPhanPanel);
        }

        add(tabbedPane, BorderLayout.CENTER);

        // Status bar
        JPanel statusBar = createStatusBar();
        add(statusBar, BorderLayout.SOUTH);
    }

    private JPanel createStatusBar() {
        JPanel panel = new JPanel(new BorderLayout());
        panel.setBorder(BorderFactory.createEmptyBorder(5, 10, 5, 10));
        panel.setBackground(new Color(240, 240, 240));

        JLabel lblStatus = new JLabel("K·∫øt n·ªëi: localhost:8888 | Ng∆∞·ªùi d√πng: " +
                                     authResponse.getUsername() + " | Quy·ªÅn: " +
                                     getRoleDisplayName());
        lblStatus.setFont(new Font("Arial", Font.PLAIN, 11));
        panel.add(lblStatus, BorderLayout.WEST);

        JLabel lblTime = new JLabel(java.time.LocalDateTime.now().format(
            java.time.format.DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm:ss")));
        lblTime.setFont(new Font("Arial", Font.PLAIN, 11));
        panel.add(lblTime, BorderLayout.EAST);

        // Update time every second
        Timer timer = new Timer(1000, e -> {
            lblTime.setText(java.time.LocalDateTime.now().format(
                java.time.format.DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm:ss")));
        });
        timer.start();

        return panel;
    }

    private void setupMenuBar() {
        JMenuBar menuBar = new JMenuBar();

        // File menu
        JMenu menuFile = new JMenu("H·ªá th·ªëng");
        menuFile.setMnemonic('H');

        JMenuItem itemRefresh = new JMenuItem("üîÑ L√†m m·ªõi");
        itemRefresh.setAccelerator(KeyStroke.getKeyStroke("F5"));
        itemRefresh.addActionListener(e -> refreshCurrentTab());

        JMenuItem itemLogout = new JMenuItem("üö™ ƒêƒÉng xu·∫•t");
        itemLogout.setAccelerator(KeyStroke.getKeyStroke("ctrl Q"));
        itemLogout.addActionListener(e -> logout());

        JMenuItem itemExit = new JMenuItem("‚ùå Tho√°t");
        itemExit.setAccelerator(KeyStroke.getKeyStroke("alt F4"));
        itemExit.addActionListener(e -> exit());

        menuFile.add(itemRefresh);
        menuFile.addSeparator();
        menuFile.add(itemLogout);
        menuFile.add(itemExit);

        // Help menu
        JMenu menuHelp = new JMenu("Tr·ª£ gi√∫p");
        menuHelp.setMnemonic('T');

        JMenuItem itemAbout = new JMenuItem("‚ÑπÔ∏è V·ªÅ ch∆∞∆°ng tr√¨nh");
        itemAbout.addActionListener(e -> showAbout());

        menuHelp.add(itemAbout);

        menuBar.add(menuFile);
        menuBar.add(menuHelp);

        setJMenuBar(menuBar);
    }

    private void refreshCurrentTab() {
        int selectedIndex = tabbedPane.getSelectedIndex();
        Component selectedComponent = tabbedPane.getSelectedComponent();

        if (selectedComponent instanceof RefreshablePanel) {
            ((RefreshablePanel) selectedComponent).refresh();
            JOptionPane.showMessageDialog(this,
                "ƒê√£ l√†m m·ªõi d·ªØ li·ªáu!",
                "Th√¥ng b√°o",
                JOptionPane.INFORMATION_MESSAGE);
        }
    }

    private void logout() {
        int choice = JOptionPane.showConfirmDialog(this,
            "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?",
            "X√°c nh·∫≠n ƒëƒÉng xu·∫•t",
            JOptionPane.YES_NO_OPTION,
            JOptionPane.QUESTION_MESSAGE);

        if (choice == JOptionPane.YES_OPTION) {
            // Send logout request
            try {
                Request request = new Request(Command.LOGOUT, null, authResponse.getAuthToken());
                networkClient.sendRequest(request);
            } catch (Exception ex) {
                ex.printStackTrace();
            }

            // Close current frame
            dispose();

            // Open login frame
            SwingUtilities.invokeLater(() -> {
                LoginFrame loginFrame = new LoginFrame();
                loginFrame.setVisible(true);
            });
        }
    }

    private void exit() {
        int choice = JOptionPane.showConfirmDialog(this,
            "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën tho√°t ch∆∞∆°ng tr√¨nh?",
            "X√°c nh·∫≠n tho√°t",
            JOptionPane.YES_NO_OPTION,
            JOptionPane.QUESTION_MESSAGE);

        if (choice == JOptionPane.YES_OPTION) {
            // Send logout request
            try {
                Request request = new Request(Command.LOGOUT, null, authResponse.getAuthToken());
                networkClient.sendRequest(request);
            } catch (Exception ex) {
                ex.printStackTrace();
            }

            networkClient.close();
            System.exit(0);
        }
    }

    private void showAbout() {
        String message = "H·ªÜ TH·ªêNG QU·∫¢N L√ù ƒê√ÄO T·∫†O\n\n" +
                        "Phi√™n b·∫£n: 2.0 (N√¢ng cao)\n" +
                        "Ki·∫øn tr√∫c: Client-Server\n" +
                        "C√¥ng ngh·ªá: Java Socket + JPA + SQL Server\n\n" +
                        "T√≠nh nƒÉng:\n" +
                        "‚Ä¢ Qu·∫£n l√Ω Khoa, L·ªõp, M√¥n h·ªçc\n" +
                        "‚Ä¢ Qu·∫£n l√Ω Gi·∫£ng vi√™n, Sinh vi√™n\n" +
                        "‚Ä¢ Qu·∫£n l√Ω L·ªõp h·ªçc ph·∫ßn\n" +
                        "‚Ä¢ ƒêƒÉng k√Ω h·ªçc ph·∫ßn, Nh·∫≠p ƒëi·ªÉm\n" +
                        "‚Ä¢ Ph√¢n quy·ªÅn theo vai tr√≤\n\n" +
                        "¬© 2024 - IUH University";

        JOptionPane.showMessageDialog(this,
            message,
            "V·ªÅ ch∆∞∆°ng tr√¨nh",
            JOptionPane.INFORMATION_MESSAGE);
    }

    private String getRoleDisplayName() {
        switch (authResponse.getRole()) {
            case ADMIN: return "Qu·∫£n tr·ªã vi√™n";
            case GIANG_VIEN: return "Gi·∫£ng vi√™n";
            case SINH_VIEN: return "Sinh vi√™n";
            default: return "Kh√¥ng x√°c ƒë·ªãnh";
        }
    }

    /**
     * Interface for panels that can be refreshed
     */
    public interface RefreshablePanel {
        void refresh();
    }
}

