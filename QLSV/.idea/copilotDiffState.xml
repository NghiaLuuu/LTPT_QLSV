<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/src/main/java/iuh/fit/se/gui/view/StudentDashboardFrame.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/java/iuh/fit/se/gui/view/StudentDashboardFrame.java" />
              <option name="originalContent" value="package iuh.fit.se.gui.view;&#10;&#10;import com.fasterxml.jackson.databind.JsonNode;&#10;import iuh.fit.se.dto.response.StudentResponse;&#10;import iuh.fit.se.dto.response.StudentDashboardResponse;&#10;import iuh.fit.se.gui.component.ModernButton;&#10;import iuh.fit.se.gui.util.ApiClient;&#10;import iuh.fit.se.gui.util.AppTheme;&#10;import iuh.fit.se.gui.util.WebSocketClient;&#10;&#10;import javax.swing.*;&#10;import javax.swing.border.EmptyBorder;&#10;import javax.swing.table.DefaultTableModel;&#10;import java.awt.*;&#10;&#10;/**&#10; * Dashboard dành cho sinh viên&#10; */&#10;public class StudentDashboardFrame extends JFrame {&#10;&#10;    private JPanel contentPanel;&#10;    private JLabel lblWelcome;&#10;    private JsonNode studentData;&#10;    private WebSocketClient webSocketClient;&#10;    private JPanel currentInfoCard; // Reference to info card để update real-time&#10;&#10;    public StudentDashboardFrame() {&#10;        initComponents();&#10;        loadStudentData();&#10;        setupWebSocket(); // Kết nối WebSocket&#10;        setTitle(&quot;Trang Sinh Viên - Hệ Thống Quản Lý Sinh Viên&quot;);&#10;        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);&#10;        setExtendedState(JFrame.MAXIMIZED_BOTH);&#10;        setLocationRelativeTo(null);&#10;&#10;        // Disconnect WebSocket khi đóng cửa sổ&#10;        addWindowListener(new java.awt.event.WindowAdapter() {&#10;            @Override&#10;            public void windowClosing(java.awt.event.WindowEvent windowEvent) {&#10;                if (webSocketClient != null) {&#10;                    webSocketClient.disconnect();&#10;                }&#10;            }&#10;        });&#10;    }&#10;&#10;    private void initComponents() {&#10;        setLayout(new BorderLayout());&#10;&#10;        // Top navigation bar&#10;        JPanel navBar = createNavBar();&#10;        add(navBar, BorderLayout.NORTH);&#10;&#10;        // Sidebar&#10;        JPanel sidebar = createSidebar();&#10;        add(sidebar, BorderLayout.WEST);&#10;&#10;        // Content area&#10;        contentPanel = new JPanel();&#10;        contentPanel.setBackground(AppTheme.BACKGROUND_COLOR);&#10;        contentPanel.setLayout(new BorderLayout());&#10;&#10;        add(contentPanel, BorderLayout.CENTER);&#10;    }&#10;&#10;    private JPanel createNavBar() {&#10;        JPanel navBar = new JPanel(new BorderLayout());&#10;        navBar.setBackground(AppTheme.PRIMARY_COLOR);&#10;        navBar.setPreferredSize(new Dimension(0, 60));&#10;        navBar.setBorder(new EmptyBorder(10, 20, 10, 20));&#10;&#10;        // Logo and title&#10;        JPanel leftPanel = new JPanel(new FlowLayout(FlowLayout.LEFT));&#10;        leftPanel.setOpaque(false);&#10;&#10;        JLabel lblLogo = new JLabel(&quot; &quot;);&#10;        lblLogo.setFont(new Font(&quot;Segoe UI Emoji&quot;, Font.PLAIN, 24));&#10;        lblLogo.setForeground(Color.WHITE);&#10;&#10;        JLabel lblTitle = new JLabel(&quot;TRANG SINH VIÊN&quot;);&#10;        lblTitle.setFont(AppTheme.HEADING_FONT);&#10;        lblTitle.setForeground(Color.WHITE);&#10;&#10;        leftPanel.add(lblLogo);&#10;        leftPanel.add(lblTitle);&#10;&#10;        // User info and logout&#10;        JPanel rightPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT));&#10;        rightPanel.setOpaque(false);&#10;&#10;        lblWelcome = new JLabel(&quot; &quot; + ApiClient.getCurrentUsername());&#10;        lblWelcome.setFont(AppTheme.NORMAL_FONT);&#10;        lblWelcome.setForeground(Color.WHITE);&#10;&#10;        ModernButton btnLogout = new ModernButton(&quot;Đăng xuất&quot;);&#10;        btnLogout.setBackground(AppTheme.DANGER_COLOR);&#10;        btnLogout.setPreferredSize(new Dimension(120, 35));&#10;        btnLogout.addActionListener(e -&gt; logout());&#10;&#10;        rightPanel.add(lblWelcome);&#10;        rightPanel.add(Box.createRigidArea(new Dimension(15, 0)));&#10;        rightPanel.add(btnLogout);&#10;&#10;        navBar.add(leftPanel, BorderLayout.WEST);&#10;        navBar.add(rightPanel, BorderLayout.EAST);&#10;&#10;        return navBar;&#10;    }&#10;&#10;    private JPanel createSidebar() {&#10;        JPanel sidebar = new JPanel();&#10;        sidebar.setLayout(new BoxLayout(sidebar, BoxLayout.Y_AXIS));&#10;        sidebar.setBackground(Color.WHITE);&#10;        sidebar.setPreferredSize(new Dimension(250, 0));&#10;        sidebar.setBorder(BorderFactory.createMatteBorder(0, 0, 0, 1, AppTheme.BORDER_COLOR));&#10;&#10;        // Menu items&#10;        addMenuItem(sidebar, &quot; Thông tin cá nhân&quot;, () -&gt; showInfoPanel());&#10;        addMenuItem(sidebar, &quot; Môn học đã đăng ký&quot;, () -&gt; showEnrollmentsPanel());&#10;        addMenuItem(sidebar, &quot; Đổi mật khẩu&quot;, () -&gt; showChangePasswordDialog());&#10;&#10;        return sidebar;&#10;    }&#10;&#10;    private void addMenuItem(JPanel sidebar, String text, Runnable action) {&#10;        JButton menuItem = new JButton(text);&#10;        menuItem.setFont(AppTheme.NORMAL_FONT);&#10;        menuItem.setForeground(AppTheme.TEXT_PRIMARY);&#10;        menuItem.setBackground(Color.WHITE);&#10;        menuItem.setHorizontalAlignment(SwingConstants.LEFT);&#10;        menuItem.setBorderPainted(false);&#10;        menuItem.setFocusPainted(false);&#10;        menuItem.setMaximumSize(new Dimension(250, 50));&#10;        menuItem.setCursor(new Cursor(Cursor.HAND_CURSOR));&#10;        menuItem.setBorder(new EmptyBorder(15, 20, 15, 20));&#10;&#10;        menuItem.addMouseListener(new java.awt.event.MouseAdapter() {&#10;            public void mouseEntered(java.awt.event.MouseEvent evt) {&#10;                menuItem.setBackground(AppTheme.BACKGROUND_COLOR);&#10;            }&#10;            public void mouseExited(java.awt.event.MouseEvent evt) {&#10;                menuItem.setBackground(Color.WHITE);&#10;            }&#10;        });&#10;&#10;        menuItem.addActionListener(e -&gt; action.run());&#10;&#10;        sidebar.add(menuItem);&#10;    }&#10;&#10;    private void loadStudentData() {&#10;        SwingWorker&lt;JsonNode, Void&gt; worker = new SwingWorker&lt;&gt;() {&#10;            @Override&#10;            protected JsonNode doInBackground() throws Exception {&#10;                String response = ApiClient.get(&quot;/students/dashboard&quot;);&#10;                return ApiClient.getObjectMapper().readTree(response);&#10;            }&#10;&#10;            @Override&#10;            protected void done() {&#10;                try {&#10;                    studentData = get();&#10;                    showInfoPanel();&#10;                } catch (Exception ex) {&#10;                    JOptionPane.showMessageDialog(StudentDashboardFrame.this,&#10;                            &quot;Lỗi khi tải dữ liệu: &quot; + ex.getMessage(),&#10;                            &quot;Lỗi&quot;,&#10;                            JOptionPane.ERROR_MESSAGE);&#10;                }&#10;            }&#10;        };&#10;        worker.execute();&#10;    }&#10;&#10;    private void showInfoPanel() {&#10;        if (studentData == null) {&#10;            return;&#10;        }&#10;&#10;        contentPanel.removeAll();&#10;&#10;        JPanel infoPanel = new JPanel();&#10;        infoPanel.setLayout(new BoxLayout(infoPanel, BoxLayout.Y_AXIS));&#10;        infoPanel.setBackground(AppTheme.BACKGROUND_COLOR);&#10;        infoPanel.setBorder(new EmptyBorder(30, 30, 30, 30));&#10;&#10;        // Title&#10;        JLabel lblTitle = new JLabel(&quot;Thông tin cá nhân&quot;);&#10;        lblTitle.setFont(AppTheme.TITLE_FONT);&#10;        lblTitle.setForeground(AppTheme.PRIMARY_COLOR);&#10;        lblTitle.setAlignmentX(Component.LEFT_ALIGNMENT);&#10;&#10;        infoPanel.add(lblTitle);&#10;        infoPanel.add(Box.createRigidArea(new Dimension(0, 20)));&#10;&#10;        // Info card&#10;        JPanel card = new JPanel();&#10;        card.setLayout(new GridLayout(6, 2, 15, 15));&#10;        card.setBackground(Color.WHITE);&#10;        card.setBorder(BorderFactory.createCompoundBorder(&#10;                BorderFactory.createLineBorder(AppTheme.BORDER_COLOR),&#10;                new EmptyBorder(30, 30, 30, 30)&#10;        ));&#10;        card.setMaximumSize(new Dimension(800, 400));&#10;        currentInfoCard = card; // Gán reference cho currentInfoCard&#10;&#10;        addInfoRow(card, &quot;Mã sinh viên:&quot;, studentData.get(&quot;studentCode&quot;).asText());&#10;        addInfoRow(card, &quot;Họ và tên:&quot;, studentData.get(&quot;fullName&quot;).asText());&#10;        addInfoRow(card, &quot;Giới tính:&quot;, studentData.get(&quot;gender&quot;).asText());&#10;        addInfoRow(card, &quot;Ngày sinh:&quot;, studentData.get(&quot;dob&quot;).asText());&#10;        addInfoRow(card, &quot;Email:&quot;, studentData.get(&quot;email&quot;).asText());&#10;        addInfoRow(card, &quot;Lớp:&quot;, studentData.has(&quot;className&quot;) ? studentData.get(&quot;className&quot;).asText() : &quot;Chưa có lớp&quot;);&#10;&#10;        infoPanel.add(card);&#10;        infoPanel.add(Box.createVerticalGlue());&#10;&#10;        contentPanel.add(infoPanel, BorderLayout.CENTER);&#10;        contentPanel.revalidate();&#10;        contentPanel.repaint();&#10;    }&#10;&#10;    private void addInfoRow(JPanel panel, String label, String value) {&#10;        JLabel lblLabel = new JLabel(label);&#10;        lblLabel.setFont(AppTheme.NORMAL_FONT.deriveFont(Font.BOLD));&#10;        lblLabel.setForeground(AppTheme.TEXT_SECONDARY);&#10;&#10;        JLabel lblValue = new JLabel(value);&#10;        lblValue.setFont(AppTheme.NORMAL_FONT);&#10;        lblValue.setForeground(AppTheme.TEXT_PRIMARY);&#10;&#10;        panel.add(lblLabel);&#10;        panel.add(lblValue);&#10;    }&#10;&#10;    private void showEnrollmentsPanel() {&#10;        if (studentData == null) {&#10;            return;&#10;        }&#10;&#10;        contentPanel.removeAll();&#10;&#10;        JPanel enrollPanel = new JPanel(new BorderLayout());&#10;        enrollPanel.setBackground(AppTheme.BACKGROUND_COLOR);&#10;        enrollPanel.setBorder(new EmptyBorder(30, 30, 30, 30));&#10;&#10;        // Title&#10;        JLabel lblTitle = new JLabel(&quot;Môn học đã đăng ký&quot;);&#10;        lblTitle.setFont(AppTheme.TITLE_FONT);&#10;        lblTitle.setForeground(AppTheme.PRIMARY_COLOR);&#10;&#10;        JPanel titlePanel = new JPanel(new FlowLayout(FlowLayout.LEFT));&#10;        titlePanel.setOpaque(false);&#10;        titlePanel.add(lblTitle);&#10;&#10;        enrollPanel.add(titlePanel, BorderLayout.NORTH);&#10;&#10;        // Table&#10;        String[] columns = {&quot;Mã môn&quot;, &quot;Tên môn học&quot;, &quot;Số tín chỉ&quot;, &quot;Học kỳ&quot;, &quot;Điểm&quot;, &quot;Giảng viên&quot;};&#10;        DefaultTableModel model = new DefaultTableModel(columns, 0) {&#10;            @Override&#10;            public boolean isCellEditable(int row, int column) {&#10;                return false;&#10;            }&#10;        };&#10;&#10;        JsonNode enrollments = studentData.get(&quot;enrollments&quot;);&#10;        if (enrollments != null &amp;&amp; enrollments.isArray()) {&#10;            for (JsonNode enrollment : enrollments) {&#10;                Object[] row = {&#10;                        enrollment.get(&quot;subjectCode&quot;).asText(),&#10;                        enrollment.get(&quot;subjectName&quot;).asText(),&#10;                        enrollment.get(&quot;credit&quot;).asInt(),&#10;                        enrollment.get(&quot;semester&quot;).asText(),&#10;                        enrollment.has(&quot;grade&quot;) &amp;&amp; !enrollment.get(&quot;grade&quot;).isNull() ?&#10;                            enrollment.get(&quot;grade&quot;).asDouble() : &quot;Chưa có&quot;,&#10;                        enrollment.has(&quot;lecturerName&quot;) &amp;&amp; !enrollment.get(&quot;lecturerName&quot;).isNull() ?&#10;                            enrollment.get(&quot;lecturerName&quot;).asText() : &quot;Chưa có&quot;&#10;                };&#10;                model.addRow(row);&#10;            }&#10;        }&#10;&#10;        JTable table = new JTable(model);&#10;        table.setFont(AppTheme.NORMAL_FONT);&#10;        table.setRowHeight(40);&#10;        table.getTableHeader().setFont(AppTheme.NORMAL_FONT.deriveFont(Font.BOLD));&#10;        table.getTableHeader().setBackground(AppTheme.PRIMARY_COLOR);&#10;        table.getTableHeader().setForeground(Color.WHITE);&#10;&#10;        JScrollPane scrollPane = new JScrollPane(table);&#10;        scrollPane.setBorder(BorderFactory.createLineBorder(AppTheme.BORDER_COLOR));&#10;&#10;        enrollPanel.add(scrollPane, BorderLayout.CENTER);&#10;&#10;        contentPanel.add(enrollPanel, BorderLayout.CENTER);&#10;        contentPanel.revalidate();&#10;        contentPanel.repaint();&#10;    }&#10;&#10;    private void showChangePasswordDialog() {&#10;        ChangePasswordDialog dialog = new ChangePasswordDialog(this);&#10;        dialog.setVisible(true);&#10;    }&#10;&#10;    private void logout() {&#10;        int choice = JOptionPane.showConfirmDialog(this,&#10;                &quot;Bạn có chắc chắn muốn đăng xuất?&quot;,&#10;                &quot;Xác nhận&quot;,&#10;                JOptionPane.YES_NO_OPTION);&#10;&#10;        if (choice == JOptionPane.YES_OPTION) {&#10;            ApiClient.clearToken();&#10;            dispose();&#10;            SwingUtilities.invokeLater(() -&gt; {&#10;                LoginFrame loginFrame = new LoginFrame();&#10;                loginFrame.setVisible(true);&#10;            });&#10;        }&#10;    }&#10;&#10;    private void setupWebSocket() {&#10;        webSocketClient = new WebSocketClient();&#10;        webSocketClient.connect(() -&gt; {&#10;            // Sau khi kết nối thành công, subscribe vào topic của sinh viên này&#10;            String currentUsername = ApiClient.getCurrentUsername();&#10;            if (currentUsername != null) {&#10;                // Subscribe vào topic riêng của sinh viên (cho cập nhật thông tin cá nhân)&#10;                webSocketClient.subscribe(&quot;/topic/student/&quot; + currentUsername, StudentResponse.class, this::handleStudentUpdate);&#10;                System.out.println(&quot;✅ WebSocket: Đã subscribe nhận thông báo cập nhật cho sinh viên: &quot; + currentUsername);&#10;&#10;                // Subscribe vào topic môn học đã đăng ký&#10;                webSocketClient.subscribe(&quot;/topic/student/&quot; + currentUsername + &quot;/enrollments&quot;, StudentDashboardResponse.class, this::handleEnrollmentUpdate);&#10;                System.out.println(&quot;✅ WebSocket: Đã subscribe nhận thông báo cập nhật môn học cho sinh viên: &quot; + currentUsername);&#10;            }&#10;        });&#10;    }&#10;&#10;    private void handleStudentUpdate(StudentResponse updatedStudent) {&#10;        // Chạy trên EDT (Event Dispatch Thread)&#10;        SwingUtilities.invokeLater(() -&gt; {&#10;            try {&#10;                System.out.println(&quot; WebSocket: Nhận được cập nhật thông tin sinh viên từ server&quot;);&#10;                System.out.println(&quot;   - Mã SV: &quot; + updatedStudent.getStudentCode());&#10;                System.out.println(&quot;   - Họ tên: &quot; + updatedStudent.getFullName());&#10;                System.out.println(&quot;   - Email: &quot; + updatedStudent.getEmail());&#10;&#10;                // Cập nhật studentData&#10;                String json = ApiClient.getObjectMapper().writeValueAsString(updatedStudent);&#10;                studentData = ApiClient.getObjectMapper().readTree(json);&#10;&#10;                // Chỉ hiển thị notification khi cập nhật thành công&#10;                JOptionPane.showMessageDialog(this,&#10;                        &quot;Thông tin cá nhân của bạn đã được cập nhật bởi quản trị viên!&quot;,&#10;                        &quot;Cập nhật thông tin&quot;,&#10;                        JOptionPane.INFORMATION_MESSAGE);&#10;&#10;                // Refresh lại màn hình hiện tại&#10;                showInfoPanel();&#10;&#10;                System.out.println(&quot;✅ WebSocket: Đã cập nhật giao diện thành công&quot;);&#10;            } catch (Exception ex) {&#10;                // Chỉ log ra console, không hiển thị dialog lỗi cho user&#10;                System.err.println(&quot;❌ WebSocket Error: Không thể xử lý cập nhật sinh viên&quot;);&#10;                System.err.println(&quot;   Chi tiết lỗi: &quot; + ex.getMessage());&#10;                ex.printStackTrace();&#10;            }&#10;        });&#10;    }&#10;&#10;    private void handleEnrollmentUpdate(StudentDashboardResponse dashboardData) {&#10;        // Chạy trên EDT (Event Dispatch Thread)&#10;        SwingUtilities.invokeLater(() -&gt; {&#10;            try {&#10;                System.out.println(&quot; WebSocket: Nhận được cập nhật môn học đã đăng ký từ server&quot;);&#10;&#10;                // Cập nhật studentData với dữ liệu mới&#10;                String json = ApiClient.getObjectMapper().writeValueAsString(dashboardData);&#10;                studentData = ApiClient.getObjectMapper().readTree(json);&#10;&#10;                // Hiển thị notification cho user&#10;                JOptionPane.showMessageDialog(this,&#10;                        &quot;Bạn đã được thêm vào môn học mới bởi quản trị viên!&quot;,&#10;                        &quot;Cập nhật môn học&quot;,&#10;                        JOptionPane.INFORMATION_MESSAGE);&#10;&#10;                // Refresh lại màn hình môn học đã đăng ký nếu đang hiển thị&#10;                showEnrollmentsPanel();&#10;&#10;                System.out.println(&quot;✅ WebSocket: Đã cập nhật danh sách môn học thành công&quot;);&#10;            } catch (Exception ex) {&#10;                // Chỉ log ra console, không hiển thị dialog lỗi cho user&#10;                System.err.println(&quot;❌ WebSocket Error: Không thể xử lý cập nhật môn học&quot;);&#10;                System.err.println(&quot;   Chi tiết lỗi: &quot; + ex.getMessage());&#10;                ex.printStackTrace();&#10;            }&#10;        });&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package iuh.fit.se.gui.view;&#10;&#10;import com.fasterxml.jackson.databind.JsonNode;&#10;import iuh.fit.se.dto.response.StudentResponse;&#10;import iuh.fit.se.dto.response.StudentDashboardResponse;&#10;import iuh.fit.se.gui.component.ModernButton;&#10;import iuh.fit.se.gui.util.ApiClient;&#10;import iuh.fit.se.gui.util.AppTheme;&#10;import iuh.fit.se.gui.util.WebSocketClient;&#10;&#10;import javax.swing.*;&#10;import javax.swing.border.EmptyBorder;&#10;import javax.swing.table.DefaultTableModel;&#10;import java.awt.*;&#10;&#10;/**&#10; * Dashboard dành cho sinh viên&#10; */&#10;public class StudentDashboardFrame extends JFrame {&#10;&#10;    private JPanel contentPanel;&#10;    private JLabel lblWelcome;&#10;    private JsonNode studentData;&#10;    private WebSocketClient webSocketClient;&#10;    private JPanel currentInfoCard; // Reference to info card để update real-time&#10;&#10;    public StudentDashboardFrame() {&#10;        initComponents();&#10;        loadStudentData();&#10;        setupWebSocket(); // Kết nối WebSocket&#10;        setTitle(&quot;Trang Sinh Viên - Hệ Thống Quản Lý Sinh Viên&quot;);&#10;        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);&#10;        setExtendedState(JFrame.MAXIMIZED_BOTH);&#10;        setLocationRelativeTo(null);&#10;&#10;        // Disconnect WebSocket khi đóng cửa sổ&#10;        addWindowListener(new java.awt.event.WindowAdapter() {&#10;            @Override&#10;            public void windowClosing(java.awt.event.WindowEvent windowEvent) {&#10;                if (webSocketClient != null) {&#10;                    webSocketClient.disconnect();&#10;                }&#10;            }&#10;        });&#10;    }&#10;&#10;    private void initComponents() {&#10;        setLayout(new BorderLayout());&#10;&#10;        // Top navigation bar&#10;        JPanel navBar = createNavBar();&#10;        add(navBar, BorderLayout.NORTH);&#10;&#10;        // Sidebar&#10;        JPanel sidebar = createSidebar();&#10;        add(sidebar, BorderLayout.WEST);&#10;&#10;        // Content area&#10;        contentPanel = new JPanel();&#10;        contentPanel.setBackground(AppTheme.BACKGROUND_COLOR);&#10;        contentPanel.setLayout(new BorderLayout());&#10;&#10;        add(contentPanel, BorderLayout.CENTER);&#10;    }&#10;&#10;    private JPanel createNavBar() {&#10;        JPanel navBar = new JPanel(new BorderLayout());&#10;        navBar.setBackground(AppTheme.PRIMARY_COLOR);&#10;        navBar.setPreferredSize(new Dimension(0, 60));&#10;        navBar.setBorder(new EmptyBorder(10, 20, 10, 20));&#10;&#10;        // Logo and title&#10;        JPanel leftPanel = new JPanel(new FlowLayout(FlowLayout.LEFT));&#10;        leftPanel.setOpaque(false);&#10;&#10;        JLabel lblLogo = new JLabel(&quot; &quot;);&#10;        lblLogo.setFont(new Font(&quot;Segoe UI Emoji&quot;, Font.PLAIN, 24));&#10;        lblLogo.setForeground(Color.WHITE);&#10;&#10;        JLabel lblTitle = new JLabel(&quot;TRANG SINH VIÊN&quot;);&#10;        lblTitle.setFont(AppTheme.HEADING_FONT);&#10;        lblTitle.setForeground(Color.WHITE);&#10;&#10;        leftPanel.add(lblLogo);&#10;        leftPanel.add(lblTitle);&#10;&#10;        // User info and logout&#10;        JPanel rightPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT));&#10;        rightPanel.setOpaque(false);&#10;&#10;        lblWelcome = new JLabel(&quot; &quot; + ApiClient.getCurrentUsername());&#10;        lblWelcome.setFont(AppTheme.NORMAL_FONT);&#10;        lblWelcome.setForeground(Color.WHITE);&#10;&#10;        ModernButton btnLogout = new ModernButton(&quot;Đăng xuất&quot;);&#10;        btnLogout.setBackground(AppTheme.DANGER_COLOR);&#10;        btnLogout.setPreferredSize(new Dimension(120, 35));&#10;        btnLogout.addActionListener(e -&gt; logout());&#10;&#10;        rightPanel.add(lblWelcome);&#10;        rightPanel.add(Box.createRigidArea(new Dimension(15, 0)));&#10;        rightPanel.add(btnLogout);&#10;&#10;        navBar.add(leftPanel, BorderLayout.WEST);&#10;        navBar.add(rightPanel, BorderLayout.EAST);&#10;&#10;        return navBar;&#10;    }&#10;&#10;    private JPanel createSidebar() {&#10;        JPanel sidebar = new JPanel();&#10;        sidebar.setLayout(new BoxLayout(sidebar, BoxLayout.Y_AXIS));&#10;        sidebar.setBackground(Color.WHITE);&#10;        sidebar.setPreferredSize(new Dimension(250, 0));&#10;        sidebar.setBorder(BorderFactory.createMatteBorder(0, 0, 0, 1, AppTheme.BORDER_COLOR));&#10;&#10;        // Menu items&#10;        addMenuItem(sidebar, &quot; Thông tin cá nhân&quot;, () -&gt; showInfoPanel());&#10;        addMenuItem(sidebar, &quot; Môn học đã đăng ký&quot;, () -&gt; showEnrollmentsPanel());&#10;        addMenuItem(sidebar, &quot; Đổi mật khẩu&quot;, () -&gt; showChangePasswordDialog());&#10;&#10;        return sidebar;&#10;    }&#10;&#10;    private void addMenuItem(JPanel sidebar, String text, Runnable action) {&#10;        JButton menuItem = new JButton(text);&#10;        menuItem.setFont(AppTheme.NORMAL_FONT);&#10;        menuItem.setForeground(AppTheme.TEXT_PRIMARY);&#10;        menuItem.setBackground(Color.WHITE);&#10;        menuItem.setHorizontalAlignment(SwingConstants.LEFT);&#10;        menuItem.setBorderPainted(false);&#10;        menuItem.setFocusPainted(false);&#10;        menuItem.setMaximumSize(new Dimension(250, 50));&#10;        menuItem.setCursor(new Cursor(Cursor.HAND_CURSOR));&#10;        menuItem.setBorder(new EmptyBorder(15, 20, 15, 20));&#10;&#10;        menuItem.addMouseListener(new java.awt.event.MouseAdapter() {&#10;            public void mouseEntered(java.awt.event.MouseEvent evt) {&#10;                menuItem.setBackground(AppTheme.BACKGROUND_COLOR);&#10;            }&#10;            public void mouseExited(java.awt.event.MouseEvent evt) {&#10;                menuItem.setBackground(Color.WHITE);&#10;            }&#10;        });&#10;&#10;        menuItem.addActionListener(e -&gt; action.run());&#10;&#10;        sidebar.add(menuItem);&#10;    }&#10;&#10;    private void loadStudentData() {&#10;        SwingWorker&lt;JsonNode, Void&gt; worker = new SwingWorker&lt;&gt;() {&#10;            @Override&#10;            protected JsonNode doInBackground() throws Exception {&#10;                String response = ApiClient.get(&quot;/students/dashboard&quot;);&#10;                return ApiClient.getObjectMapper().readTree(response);&#10;            }&#10;&#10;            @Override&#10;            protected void done() {&#10;                try {&#10;                    studentData = get();&#10;                    showInfoPanel();&#10;                } catch (Exception ex) {&#10;                    JOptionPane.showMessageDialog(StudentDashboardFrame.this,&#10;                            &quot;Lỗi khi tải dữ liệu: &quot; + ex.getMessage(),&#10;                            &quot;Lỗi&quot;,&#10;                            JOptionPane.ERROR_MESSAGE);&#10;                }&#10;            }&#10;        };&#10;        worker.execute();&#10;    }&#10;&#10;    private void showInfoPanel() {&#10;        if (studentData == null) {&#10;            return;&#10;        }&#10;&#10;        contentPanel.removeAll();&#10;&#10;        JPanel infoPanel = new JPanel();&#10;        infoPanel.setLayout(new BoxLayout(infoPanel, BoxLayout.Y_AXIS));&#10;        infoPanel.setBackground(AppTheme.BACKGROUND_COLOR);&#10;        infoPanel.setBorder(new EmptyBorder(30, 30, 30, 30));&#10;&#10;        // Title&#10;        JLabel lblTitle = new JLabel(&quot;Thông tin cá nhân&quot;);&#10;        lblTitle.setFont(AppTheme.TITLE_FONT);&#10;        lblTitle.setForeground(AppTheme.PRIMARY_COLOR);&#10;        lblTitle.setAlignmentX(Component.LEFT_ALIGNMENT);&#10;&#10;        infoPanel.add(lblTitle);&#10;        infoPanel.add(Box.createRigidArea(new Dimension(0, 20)));&#10;&#10;        // Info card&#10;        JPanel card = new JPanel();&#10;        card.setLayout(new GridLayout(6, 2, 15, 15));&#10;        card.setBackground(Color.WHITE);&#10;        card.setBorder(BorderFactory.createCompoundBorder(&#10;                BorderFactory.createLineBorder(AppTheme.BORDER_COLOR),&#10;                new EmptyBorder(30, 30, 30, 30)&#10;        ));&#10;        card.setMaximumSize(new Dimension(800, 400));&#10;        currentInfoCard = card; // Gán reference cho currentInfoCard&#10;&#10;        addInfoRow(card, &quot;Mã sinh viên:&quot;, studentData.get(&quot;studentCode&quot;).asText());&#10;        addInfoRow(card, &quot;Họ và tên:&quot;, studentData.get(&quot;fullName&quot;).asText());&#10;        addInfoRow(card, &quot;Giới tính:&quot;, studentData.get(&quot;gender&quot;).asText());&#10;        addInfoRow(card, &quot;Ngày sinh:&quot;, studentData.get(&quot;dob&quot;).asText());&#10;        addInfoRow(card, &quot;Email:&quot;, studentData.get(&quot;email&quot;).asText());&#10;        addInfoRow(card, &quot;Lớp:&quot;, studentData.has(&quot;className&quot;) ? studentData.get(&quot;className&quot;).asText() : &quot;Chưa có lớp&quot;);&#10;&#10;        infoPanel.add(card);&#10;        infoPanel.add(Box.createVerticalGlue());&#10;&#10;        contentPanel.add(infoPanel, BorderLayout.CENTER);&#10;        contentPanel.revalidate();&#10;        contentPanel.repaint();&#10;    }&#10;&#10;    private void addInfoRow(JPanel panel, String label, String value) {&#10;        JLabel lblLabel = new JLabel(label);&#10;        lblLabel.setFont(AppTheme.NORMAL_FONT.deriveFont(Font.BOLD));&#10;        lblLabel.setForeground(AppTheme.TEXT_SECONDARY);&#10;&#10;        JLabel lblValue = new JLabel(value);&#10;        lblValue.setFont(AppTheme.NORMAL_FONT);&#10;        lblValue.setForeground(AppTheme.TEXT_PRIMARY);&#10;&#10;        panel.add(lblLabel);&#10;        panel.add(lblValue);&#10;    }&#10;&#10;    private void showEnrollmentsPanel() {&#10;        if (studentData == null) {&#10;            return;&#10;        }&#10;&#10;        contentPanel.removeAll();&#10;&#10;        JPanel enrollPanel = new JPanel(new BorderLayout());&#10;        enrollPanel.setBackground(AppTheme.BACKGROUND_COLOR);&#10;        enrollPanel.setBorder(new EmptyBorder(30, 30, 30, 30));&#10;&#10;        // Title&#10;        JLabel lblTitle = new JLabel(&quot;Môn học đã đăng ký&quot;);&#10;        lblTitle.setFont(AppTheme.TITLE_FONT);&#10;        lblTitle.setForeground(AppTheme.PRIMARY_COLOR);&#10;&#10;        JPanel titlePanel = new JPanel(new FlowLayout(FlowLayout.LEFT));&#10;        titlePanel.setOpaque(false);&#10;        titlePanel.add(lblTitle);&#10;&#10;        enrollPanel.add(titlePanel, BorderLayout.NORTH);&#10;&#10;        // Table&#10;        String[] columns = {&quot;Mã môn&quot;, &quot;Tên môn học&quot;, &quot;Số tín chỉ&quot;, &quot;Học kỳ&quot;, &quot;Điểm&quot;, &quot;Giảng viên&quot;};&#10;        DefaultTableModel model = new DefaultTableModel(columns, 0) {&#10;            @Override&#10;            public boolean isCellEditable(int row, int column) {&#10;                return false;&#10;            }&#10;        };&#10;&#10;        JsonNode enrollments = studentData.get(&quot;enrollments&quot;);&#10;        if (enrollments != null &amp;&amp; enrollments.isArray()) {&#10;            for (JsonNode enrollment : enrollments) {&#10;                Object[] row = {&#10;                        enrollment.get(&quot;subjectCode&quot;).asText(),&#10;                        enrollment.get(&quot;subjectName&quot;).asText(),&#10;                        enrollment.get(&quot;credit&quot;).asInt(),&#10;                        enrollment.get(&quot;semester&quot;).asText(),&#10;                        enrollment.has(&quot;grade&quot;) &amp;&amp; !enrollment.get(&quot;grade&quot;).isNull() ?&#10;                            enrollment.get(&quot;grade&quot;).asDouble() : &quot;Chưa có&quot;,&#10;                        enrollment.has(&quot;lecturerName&quot;) &amp;&amp; !enrollment.get(&quot;lecturerName&quot;).isNull() ?&#10;                            enrollment.get(&quot;lecturerName&quot;).asText() : &quot;Chưa có&quot;&#10;                };&#10;                model.addRow(row);&#10;            }&#10;        }&#10;&#10;        JTable table = new JTable(model);&#10;        table.setFont(AppTheme.NORMAL_FONT);&#10;        table.setRowHeight(40);&#10;        table.getTableHeader().setFont(AppTheme.NORMAL_FONT.deriveFont(Font.BOLD));&#10;        table.getTableHeader().setBackground(AppTheme.PRIMARY_COLOR);&#10;        table.getTableHeader().setForeground(Color.WHITE);&#10;&#10;        JScrollPane scrollPane = new JScrollPane(table);&#10;        scrollPane.setBorder(BorderFactory.createLineBorder(AppTheme.BORDER_COLOR));&#10;&#10;        enrollPanel.add(scrollPane, BorderLayout.CENTER);&#10;&#10;        contentPanel.add(enrollPanel, BorderLayout.CENTER);&#10;        contentPanel.revalidate();&#10;        contentPanel.repaint();&#10;    }&#10;&#10;    private void showChangePasswordDialog() {&#10;        ChangePasswordDialog dialog = new ChangePasswordDialog(this);&#10;        dialog.setVisible(true);&#10;    }&#10;&#10;    private void logout() {&#10;        int choice = JOptionPane.showConfirmDialog(this,&#10;                &quot;Bạn có chắc chắn muốn đăng xuất?&quot;,&#10;                &quot;Xác nhận&quot;,&#10;                JOptionPane.YES_NO_OPTION);&#10;&#10;        if (choice == JOptionPane.YES_OPTION) {&#10;            ApiClient.clearToken();&#10;            dispose();&#10;            SwingUtilities.invokeLater(() -&gt; {&#10;                LoginFrame loginFrame = new LoginFrame();&#10;                loginFrame.setVisible(true);&#10;            });&#10;        }&#10;    }&#10;&#10;    private void setupWebSocket() {&#10;        webSocketClient = new WebSocketClient();&#10;        webSocketClient.connect(() -&gt; {&#10;            String currentUsername = ApiClient.getCurrentUsername();&#10;            if (currentUsername != null) {&#10;                System.out.println(&quot; [WEBSOCKET - STUDENT] Bắt đầu kết nối WebSocket&quot;);&#10;                System.out.println(&quot;   └─ Username: &quot; + currentUsername);&#10;                &#10;                //  REAL-TIME: Subscribe vào group chung với tất cả admin và students&#10;                webSocketClient.subscribe(&quot;/topic/students/updates&quot;, StudentResponse.class, this::handleStudentUpdateRealtime);&#10;                System.out.println(&quot;✅ [WEBSOCKET - STUDENT] Đã join vào group real-time&quot;);&#10;                System.out.println(&quot;   ├─ Topic: /topic/students/updates&quot;);&#10;                System.out.println(&quot;   └─ Sẽ tự động filter message cho sinh viên: &quot; + currentUsername);&#10;&#10;                // Subscribe vào topic môn học đã đăng ký&#10;                webSocketClient.subscribe(&quot;/topic/student/&quot; + currentUsername + &quot;/enrollments&quot;, StudentDashboardResponse.class, this::handleEnrollmentUpdate);&#10;                System.out.println(&quot;✅ [WEBSOCKET - STUDENT] Đã subscribe topic môn học&quot;);&#10;                System.out.println(&quot;   └─ Topic: /topic/student/&quot; + currentUsername + &quot;/enrollments&quot;);&#10;            }&#10;        });&#10;    }&#10;&#10;    private void handleStudentUpdateRealtime(StudentResponse updatedStudent) {&#10;        // Chạy trên EDT (Event Dispatch Thread)&#10;        SwingUtilities.invokeLater(() -&gt; {&#10;            try {&#10;                String currentUsername = ApiClient.getCurrentUsername();&#10;                &#10;                System.out.println(&quot; [WEBSOCKET - STUDENT] Nhận được broadcast cập nhật sinh viên từ group&quot;);&#10;                System.out.println(&quot;   ├─ Mã SV trong message: &quot; + updatedStudent.getStudentCode());&#10;                System.out.println(&quot;   ├─ Họ tên: &quot; + updatedStudent.getFullName());&#10;                System.out.println(&quot;   ├─ Email: &quot; + updatedStudent.getEmail());&#10;                System.out.println(&quot;   └─ Username hiện tại: &quot; + currentUsername);&#10;&#10;                //  FILTER: Chỉ xử lý nếu là update của chính mình&#10;                if (updatedStudent.getStudentCode().equals(currentUsername)) {&#10;                    System.out.println(&quot;✅ [FILTER] Message này dành cho tôi! Đang cập nhật giao diện...&quot;);&#10;                    &#10;                    // Cập nhật studentData&#10;                    String json = ApiClient.getObjectMapper().writeValueAsString(updatedStudent);&#10;                    studentData = ApiClient.getObjectMapper().readTree(json);&#10;&#10;                    // Hiển thị notification&#10;                    JOptionPane.showMessageDialog(this,&#10;                            &quot;Thông tin cá nhân của bạn đã được cập nhật bởi quản trị viên!\n\n&quot; +&#10;                            &quot;Mã SV: &quot; + updatedStudent.getStudentCode() + &quot;\n&quot; +&#10;                            &quot;Họ tên: &quot; + updatedStudent.getFullName() + &quot;\n&quot; +&#10;                            &quot;Email: &quot; + updatedStudent.getEmail(),&#10;                            &quot; Cập nhật thông tin - REAL-TIME&quot;,&#10;                            JOptionPane.INFORMATION_MESSAGE);&#10;&#10;                    // Refresh lại màn hình hiện tại&#10;                    showInfoPanel();&#10;&#10;                    System.out.println(&quot;✅ [WEBSOCKET - STUDENT] Đã cập nhật giao diện real-time thành công&quot;);&#10;                } else {&#10;                    System.out.println(&quot;⏭️  [FILTER] Message này không phải của tôi, bỏ qua&quot;);&#10;                    System.out.println(&quot;   └─ Message dành cho: &quot; + updatedStudent.getStudentCode());&#10;                }&#10;            } catch (Exception ex) {&#10;                System.err.println(&quot;❌ [WEBSOCKET - STUDENT] Lỗi khi xử lý cập nhật real-time&quot;);&#10;                System.err.println(&quot;   └─ Chi tiết: &quot; + ex.getMessage());&#10;                ex.printStackTrace();&#10;            }&#10;        });&#10;    }&#10;&#10;    private void handleEnrollmentUpdate(StudentDashboardResponse dashboardData) {&#10;        // Chạy trên EDT (Event Dispatch Thread)&#10;        SwingUtilities.invokeLater(() -&gt; {&#10;            try {&#10;                System.out.println(&quot; WebSocket: Nhận được cập nhật môn học đã đăng ký từ server&quot;);&#10;&#10;                // Cập nhật studentData với dữ liệu mới&#10;                String json = ApiClient.getObjectMapper().writeValueAsString(dashboardData);&#10;                studentData = ApiClient.getObjectMapper().readTree(json);&#10;&#10;                // Hiển thị notification cho user&#10;                JOptionPane.showMessageDialog(this,&#10;                        &quot;Bạn đã được thêm vào môn học mới bởi quản trị viên!&quot;,&#10;                        &quot;Cập nhật môn học&quot;,&#10;                        JOptionPane.INFORMATION_MESSAGE);&#10;&#10;                // Refresh lại màn hình môn học đã đăng ký nếu đang hiển thị&#10;                showEnrollmentsPanel();&#10;&#10;                System.out.println(&quot;✅ WebSocket: Đã cập nhật danh sách môn học thành công&quot;);&#10;            } catch (Exception ex) {&#10;                // Chỉ log ra console, không hiển thị dialog lỗi cho user&#10;                System.err.println(&quot;❌ WebSocket Error: Không thể xử lý cập nhật môn học&quot;);&#10;                System.err.println(&quot;   Chi tiết lỗi: &quot; + ex.getMessage());&#10;                ex.printStackTrace();&#10;            }&#10;        });&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/src/main/java/iuh/fit/se/service/impl/StudentServiceImpl.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/java/iuh/fit/se/service/impl/StudentServiceImpl.java" />
              <option name="originalContent" value="package iuh.fit.se.service.impl;&#10;&#10;import iuh.fit.se.dto.request.StudentRequest;&#10;import iuh.fit.se.dto.response.StudentResponse;&#10;import iuh.fit.se.dto.response.StudentDashboardResponse;&#10;import iuh.fit.se.exception.ConflictException;&#10;import iuh.fit.se.exception.ResourceNotFoundException;&#10;import iuh.fit.se.model.Class;&#10;import iuh.fit.se.model.Faculty;&#10;import iuh.fit.se.model.Notification;&#10;import iuh.fit.se.model.Student;&#10;import iuh.fit.se.model.User;&#10;import iuh.fit.se.model.Role;&#10;import iuh.fit.se.repository.ClassRepository;&#10;import iuh.fit.se.repository.FacultyRepository;&#10;import iuh.fit.se.repository.NotificationRepository;&#10;import iuh.fit.se.repository.StudentRepository;&#10;import iuh.fit.se.repository.UserRepository;&#10;import iuh.fit.se.service.StudentService;&#10;import iuh.fit.se.util.LocalCacheClient;&#10;import org.springframework.beans.factory.annotation.Autowired;&#10;import org.springframework.messaging.simp.SimpMessagingTemplate;&#10;import org.springframework.security.crypto.password.PasswordEncoder;&#10;import org.springframework.stereotype.Service;&#10;import org.springframework.transaction.annotation.Transactional;&#10;&#10;import java.time.LocalDateTime;&#10;import java.util.List;&#10;import java.util.stream.Collectors;&#10;&#10;@Service&#10;public class StudentServiceImpl implements StudentService {&#10;&#10;    @Autowired&#10;    private StudentRepository studentRepository;&#10;&#10;    @Autowired&#10;    private ClassRepository classRepository;&#10;&#10;    @Autowired&#10;    private FacultyRepository facultyRepository;&#10;&#10;    @Autowired&#10;    private NotificationRepository notificationRepository;&#10;&#10;    @Autowired&#10;    private SimpMessagingTemplate messagingTemplate;&#10;&#10;    @Autowired&#10;    private UserRepository userRepository;&#10;&#10;    @Autowired&#10;    private PasswordEncoder passwordEncoder;&#10;&#10;    @Autowired&#10;    private LocalCacheClient localCacheClient;&#10;&#10;    @Override&#10;    @Transactional&#10;    public StudentResponse createStudent(StudentRequest request) {&#10;        // Tự động sinh mã nếu không có&#10;        String studentCode = request.getStudentCode();&#10;        if (studentCode == null || studentCode.isEmpty()) {&#10;            studentCode = generateStudentCode();&#10;        }&#10;&#10;        if (studentRepository.existsByStudentCode(studentCode)) {&#10;            throw new ConflictException(&quot;Mã sinh viên đã tồn tại&quot;);&#10;        }&#10;&#10;        if (studentRepository.existsByEmail(request.getEmail())) {&#10;            throw new ConflictException(&quot;Email đã tồn tại&quot;);&#10;        }&#10;&#10;        // Create user account for student with default password&#10;        User user = new User();&#10;        user.setUsername(studentCode);&#10;        user.setPassword(passwordEncoder.encode(&quot;12345678&quot;)); // Default password&#10;        user.setRole(Role.STUDENT);&#10;        user.setActive(true);&#10;&#10;        Student student = new Student();&#10;        student.setStudentCode(studentCode);&#10;        student.setFullName(request.getFullName());&#10;        student.setGender(request.getGender());&#10;        student.setDob(request.getDob());&#10;        student.setEmail(request.getEmail());&#10;        student.setUser(user);&#10;&#10;        if (request.getClassId() != null) {&#10;            Class studentClass = classRepository.findById(request.getClassId())&#10;                    .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Lớp không tồn tại&quot;));&#10;            student.setStudentClass(studentClass);&#10;        }&#10;&#10;        if (request.getFacultyId() != null) {&#10;            Faculty faculty = facultyRepository.findById(request.getFacultyId())&#10;                    .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Khoa không tồn tại&quot;));&#10;            student.setFaculty(faculty);&#10;        }&#10;&#10;        Student savedStudent = studentRepository.save(student);&#10;&#10;        // Gửi thông báo realtime&#10;        Notification notification = new Notification();&#10;        notification.setTitle(&quot;Sinh viên mới&quot;);&#10;        notification.setMessage(&quot;Sinh viên &quot; + savedStudent.getFullName() + &quot; đã được thêm vào hệ thống&quot;);&#10;        notification.setCreatedAt(LocalDateTime.now());&#10;        notificationRepository.save(notification);&#10;&#10;        messagingTemplate.convertAndSend(&quot;/topic/students&quot;, new StudentResponse(savedStudent));&#10;&#10;        return new StudentResponse(savedStudent);&#10;    }&#10;&#10;    @Override&#10;    @Transactional&#10;    public StudentResponse updateStudent(Long id, StudentRequest request) {&#10;        Student student = studentRepository.findById(id)&#10;                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Sinh viên không tồn tại&quot;));&#10;&#10;        // Kiểm tra trùng mã sinh viên&#10;        if (!student.getStudentCode().equals(request.getStudentCode()) &amp;&amp;&#10;                studentRepository.existsByStudentCode(request.getStudentCode())) {&#10;            throw new ConflictException(&quot;Mã sinh viên đã tồn tại&quot;);&#10;        }&#10;&#10;        // Kiểm tra trùng email&#10;        if (!student.getEmail().equals(request.getEmail()) &amp;&amp;&#10;                studentRepository.existsByEmail(request.getEmail())) {&#10;            throw new ConflictException(&quot;Email đã tồn tại&quot;);&#10;        }&#10;&#10;        student.setStudentCode(request.getStudentCode());&#10;        student.setFullName(request.getFullName());&#10;        student.setGender(request.getGender());&#10;        student.setDob(request.getDob());&#10;        student.setEmail(request.getEmail());&#10;&#10;        if (request.getClassId() != null) {&#10;            Class studentClass = classRepository.findById(request.getClassId())&#10;                    .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Lớp không tồn tại&quot;));&#10;            student.setStudentClass(studentClass);&#10;        }&#10;&#10;        if (request.getFacultyId() != null) {&#10;            Faculty faculty = facultyRepository.findById(request.getFacultyId())&#10;                    .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Khoa không tồn tại&quot;));&#10;            student.setFaculty(faculty);&#10;        }&#10;&#10;        Student updatedStudent = studentRepository.save(student);&#10;        StudentResponse response = new StudentResponse(updatedStudent);&#10;&#10;        // Xóa cache khi cập nhật&#10;        localCacheClient.evict(&quot;students:all&quot;);&#10;        localCacheClient.evict(&quot;student:dashboard:&quot; + updatedStudent.getStudentCode());&#10;&#10;        // Gửi WebSocket message cho sinh viên cụ thể&#10;        String studentUsername = updatedStudent.getUser() != null ? updatedStudent.getUser().getUsername() : updatedStudent.getStudentCode();&#10;        messagingTemplate.convertAndSend(&quot;/topic/student/&quot; + studentUsername, response);&#10;&#10;        // Gửi notification chung cho tất cả&#10;        messagingTemplate.convertAndSend(&quot;/topic/students&quot;, response);&#10;&#10;        System.out.println(&quot; [WEBSOCKET] Đã gửi thông báo cập nhật sinh viên: &quot; + updatedStudent.getStudentCode());&#10;&#10;        return response;&#10;    }&#10;&#10;    @Override&#10;    @Transactional&#10;    public void deleteStudent(Long id) {&#10;        Student student = studentRepository.findById(id)&#10;                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Sinh viên không tồn tại&quot;));&#10;&#10;        // Delete associated user account&#10;        if (student.getUser() != null) {&#10;            userRepository.delete(student.getUser());&#10;        }&#10;&#10;        studentRepository.delete(student);&#10;    }&#10;&#10;    @Override&#10;    public StudentResponse getStudentById(Long id) {&#10;        Student student = studentRepository.findById(id)&#10;                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Sinh viên không tồn tại&quot;));&#10;        return new StudentResponse(student);&#10;    }&#10;&#10;    @Override&#10;    public List&lt;StudentResponse&gt; getAllStudents() {&#10;        return studentRepository.findAll().stream()&#10;                .map(StudentResponse::new)&#10;                .collect(Collectors.toList());&#10;    }&#10;&#10;    public StudentDashboardResponse getStudentDashboard(String studentCode) {&#10;        Student student = studentRepository.findByStudentCode(studentCode)&#10;                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Sinh viên không tồn tại&quot;));&#10;        return new StudentDashboardResponse(student);&#10;    }&#10;&#10;    @Transactional&#10;    public void resetPassword(Long studentId) {&#10;        Student student = studentRepository.findById(studentId)&#10;                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Sinh viên không tồn tại&quot;));&#10;&#10;        if (student.getUser() != null) {&#10;            student.getUser().setPassword(passwordEncoder.encode(&quot;12345678&quot;));&#10;            userRepository.save(student.getUser());&#10;        } else {&#10;            throw new ResourceNotFoundException(&quot;Tài khoản sinh viên không tồn tại&quot;);&#10;        }&#10;    }&#10;&#10;    private String generateStudentCode() {&#10;        long count = studentRepository.count();&#10;        return String.format(&quot;SV%08d&quot;, count + 1);&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package iuh.fit.se.service.impl;&#13;&#10;&#13;&#10;import iuh.fit.se.dto.request.StudentRequest;&#13;&#10;import iuh.fit.se.dto.response.StudentResponse;&#13;&#10;import iuh.fit.se.dto.response.StudentDashboardResponse;&#13;&#10;import iuh.fit.se.exception.ConflictException;&#13;&#10;import iuh.fit.se.exception.ResourceNotFoundException;&#13;&#10;import iuh.fit.se.model.Class;&#13;&#10;import iuh.fit.se.model.Faculty;&#13;&#10;import iuh.fit.se.model.Notification;&#13;&#10;import iuh.fit.se.model.Student;&#13;&#10;import iuh.fit.se.model.User;&#13;&#10;import iuh.fit.se.model.Role;&#13;&#10;import iuh.fit.se.repository.ClassRepository;&#13;&#10;import iuh.fit.se.repository.FacultyRepository;&#13;&#10;import iuh.fit.se.repository.NotificationRepository;&#13;&#10;import iuh.fit.se.repository.StudentRepository;&#13;&#10;import iuh.fit.se.repository.UserRepository;&#13;&#10;import iuh.fit.se.service.StudentService;&#13;&#10;import iuh.fit.se.util.LocalCacheClient;&#13;&#10;import org.springframework.beans.factory.annotation.Autowired;&#13;&#10;import org.springframework.messaging.simp.SimpMessagingTemplate;&#13;&#10;import org.springframework.security.crypto.password.PasswordEncoder;&#13;&#10;import org.springframework.stereotype.Service;&#13;&#10;import org.springframework.transaction.annotation.Transactional;&#13;&#10;&#13;&#10;import java.time.LocalDateTime;&#13;&#10;import java.util.List;&#13;&#10;import java.util.stream.Collectors;&#13;&#10;&#13;&#10;@Service&#13;&#10;public class StudentServiceImpl implements StudentService {&#13;&#10;&#13;&#10;    @Autowired&#13;&#10;    private StudentRepository studentRepository;&#13;&#10;&#13;&#10;    @Autowired&#13;&#10;    private ClassRepository classRepository;&#13;&#10;&#13;&#10;    @Autowired&#13;&#10;    private FacultyRepository facultyRepository;&#13;&#10;&#13;&#10;    @Autowired&#13;&#10;    private NotificationRepository notificationRepository;&#13;&#10;&#13;&#10;    @Autowired&#13;&#10;    private SimpMessagingTemplate messagingTemplate;&#13;&#10;&#13;&#10;    @Autowired&#13;&#10;    private UserRepository userRepository;&#13;&#10;&#13;&#10;    @Autowired&#13;&#10;    private PasswordEncoder passwordEncoder;&#13;&#10;&#13;&#10;    @Autowired&#13;&#10;    private LocalCacheClient localCacheClient;&#13;&#10;&#13;&#10;    @Override&#13;&#10;    @Transactional&#13;&#10;    public StudentResponse createStudent(StudentRequest request) {&#13;&#10;        // Tự động sinh mã nếu không có&#13;&#10;        String studentCode = request.getStudentCode();&#13;&#10;        if (studentCode == null || studentCode.isEmpty()) {&#13;&#10;            studentCode = generateStudentCode();&#13;&#10;        }&#13;&#10;&#13;&#10;        if (studentRepository.existsByStudentCode(studentCode)) {&#13;&#10;            throw new ConflictException(&quot;Mã sinh viên đã tồn tại&quot;);&#13;&#10;        }&#13;&#10;&#13;&#10;        if (studentRepository.existsByEmail(request.getEmail())) {&#13;&#10;            throw new ConflictException(&quot;Email đã tồn tại&quot;);&#13;&#10;        }&#13;&#10;&#13;&#10;        // Create user account for student with default password&#13;&#10;        User user = new User();&#13;&#10;        user.setUsername(studentCode);&#13;&#10;        user.setPassword(passwordEncoder.encode(&quot;12345678&quot;)); // Default password&#13;&#10;        user.setRole(Role.STUDENT);&#13;&#10;        user.setActive(true);&#13;&#10;&#13;&#10;        Student student = new Student();&#13;&#10;        student.setStudentCode(studentCode);&#13;&#10;        student.setFullName(request.getFullName());&#13;&#10;        student.setGender(request.getGender());&#13;&#10;        student.setDob(request.getDob());&#13;&#10;        student.setEmail(request.getEmail());&#13;&#10;        student.setUser(user);&#13;&#10;&#13;&#10;        if (request.getClassId() != null) {&#13;&#10;            Class studentClass = classRepository.findById(request.getClassId())&#13;&#10;                    .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Lớp không tồn tại&quot;));&#13;&#10;            student.setStudentClass(studentClass);&#13;&#10;        }&#13;&#10;&#13;&#10;        if (request.getFacultyId() != null) {&#13;&#10;            Faculty faculty = facultyRepository.findById(request.getFacultyId())&#13;&#10;                    .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Khoa không tồn tại&quot;));&#13;&#10;            student.setFaculty(faculty);&#13;&#10;        }&#13;&#10;&#13;&#10;        Student savedStudent = studentRepository.save(student);&#13;&#10;&#13;&#10;        // Gửi thông báo realtime&#13;&#10;        Notification notification = new Notification();&#13;&#10;        notification.setTitle(&quot;Sinh viên mới&quot;);&#13;&#10;        notification.setMessage(&quot;Sinh viên &quot; + savedStudent.getFullName() + &quot; đã được thêm vào hệ thống&quot;);&#13;&#10;        notification.setCreatedAt(LocalDateTime.now());&#13;&#10;        notificationRepository.save(notification);&#13;&#10;&#13;&#10;        messagingTemplate.convertAndSend(&quot;/topic/students&quot;, new StudentResponse(savedStudent));&#13;&#10;&#13;&#10;        return new StudentResponse(savedStudent);&#13;&#10;    }&#13;&#10;&#13;&#10;    @Override&#13;&#10;    @Transactional&#13;&#10;    public StudentResponse updateStudent(Long id, StudentRequest request) {&#13;&#10;        Student student = studentRepository.findById(id)&#13;&#10;                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Sinh viên không tồn tại&quot;));&#13;&#10;&#13;&#10;        // Kiểm tra trùng mã sinh viên&#13;&#10;        if (!student.getStudentCode().equals(request.getStudentCode()) &amp;&amp;&#13;&#10;                studentRepository.existsByStudentCode(request.getStudentCode())) {&#13;&#10;            throw new ConflictException(&quot;Mã sinh viên đã tồn tại&quot;);&#13;&#10;        }&#13;&#10;&#13;&#10;        // Kiểm tra trùng email&#13;&#10;        if (!student.getEmail().equals(request.getEmail()) &amp;&amp;&#13;&#10;                studentRepository.existsByEmail(request.getEmail())) {&#13;&#10;            throw new ConflictException(&quot;Email đã tồn tại&quot;);&#13;&#10;        }&#13;&#10;&#13;&#10;        student.setStudentCode(request.getStudentCode());&#13;&#10;        student.setFullName(request.getFullName());&#13;&#10;        student.setGender(request.getGender());&#13;&#10;        student.setDob(request.getDob());&#13;&#10;        student.setEmail(request.getEmail());&#13;&#10;&#13;&#10;        if (request.getClassId() != null) {&#13;&#10;            Class studentClass = classRepository.findById(request.getClassId())&#13;&#10;                    .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Lớp không tồn tại&quot;));&#13;&#10;            student.setStudentClass(studentClass);&#13;&#10;        }&#13;&#10;&#13;&#10;        if (request.getFacultyId() != null) {&#13;&#10;            Faculty faculty = facultyRepository.findById(request.getFacultyId())&#13;&#10;                    .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Khoa không tồn tại&quot;));&#13;&#10;            student.setFaculty(faculty);&#13;&#10;        }&#13;&#10;&#13;&#10;        Student updatedStudent = studentRepository.save(student);&#13;&#10;        StudentResponse response = new StudentResponse(updatedStudent);&#13;&#10;&#13;&#10;        // Xóa cache khi cập nhật&#13;&#10;        localCacheClient.evict(&quot;students:all&quot;);&#13;&#10;        localCacheClient.evict(&quot;student:dashboard:&quot; + updatedStudent.getStudentCode());&#13;&#10;&#13;&#10;        //  REAL-TIME: Gửi vào group chung cho tất cả admin và students&#13;&#10;        messagingTemplate.convertAndSend(&quot;/topic/students/updates&quot;, response);&#13;&#10;        &#13;&#10;        System.out.println(&quot; [WEBSOCKET - REAL-TIME] Broadcast cập nhật sinh viên đến group chung&quot;);&#13;&#10;        System.out.println(&quot;   ├─ Mã SV: &quot; + updatedStudent.getStudentCode());&#13;&#10;        System.out.println(&quot;   ├─ Họ tên: &quot; + updatedStudent.getFullName());&#13;&#10;        System.out.println(&quot;   ├─ Email: &quot; + updatedStudent.getEmail());&#13;&#10;        System.out.println(&quot;   └─ Topic: /topic/students/updates&quot;);&#13;&#10;&#13;&#10;        return response;&#13;&#10;    }&#13;&#10;&#13;&#10;    @Override&#13;&#10;    @Transactional&#13;&#10;    public void deleteStudent(Long id) {&#13;&#10;        Student student = studentRepository.findById(id)&#13;&#10;                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Sinh viên không tồn tại&quot;));&#13;&#10;&#13;&#10;        // Delete associated user account&#13;&#10;        if (student.getUser() != null) {&#13;&#10;            userRepository.delete(student.getUser());&#13;&#10;        }&#13;&#10;&#13;&#10;        studentRepository.delete(student);&#13;&#10;    }&#13;&#10;&#13;&#10;    @Override&#13;&#10;    public StudentResponse getStudentById(Long id) {&#13;&#10;        Student student = studentRepository.findById(id)&#13;&#10;                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Sinh viên không tồn tại&quot;));&#13;&#10;        return new StudentResponse(student);&#13;&#10;    }&#13;&#10;&#13;&#10;    @Override&#13;&#10;    public List&lt;StudentResponse&gt; getAllStudents() {&#13;&#10;        return studentRepository.findAll().stream()&#13;&#10;                .map(StudentResponse::new)&#13;&#10;                .collect(Collectors.toList());&#13;&#10;    }&#13;&#10;&#13;&#10;    public StudentDashboardResponse getStudentDashboard(String studentCode) {&#13;&#10;        Student student = studentRepository.findByStudentCode(studentCode)&#13;&#10;                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Sinh viên không tồn tại&quot;));&#13;&#10;        return new StudentDashboardResponse(student);&#13;&#10;    }&#13;&#10;&#13;&#10;    @Transactional&#13;&#10;    public void resetPassword(Long studentId) {&#13;&#10;        Student student = studentRepository.findById(studentId)&#13;&#10;                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Sinh viên không tồn tại&quot;));&#13;&#10;&#13;&#10;        if (student.getUser() != null) {&#13;&#10;            student.getUser().setPassword(passwordEncoder.encode(&quot;12345678&quot;));&#13;&#10;            userRepository.save(student.getUser());&#13;&#10;        } else {&#13;&#10;            throw new ResourceNotFoundException(&quot;Tài khoản sinh viên không tồn tại&quot;);&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    private String generateStudentCode() {&#13;&#10;        long count = studentRepository.count();&#13;&#10;        return String.format(&quot;SV%08d&quot;, count + 1);&#13;&#10;    }&#13;&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>